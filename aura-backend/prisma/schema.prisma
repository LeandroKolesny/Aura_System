// Aura System - Schema do Banco de Dados
// Sistema de Gestão para Clínicas de Estética
// Usando Prisma com PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// MÓDULO: AUTENTICAÇÃO E USUÁRIOS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String    // Hash bcrypt - OBRIGATÓRIO
  avatar        String?
  phone         String?
  role          UserRole  @default(ESTHETICIAN)
  isActive      Boolean   @default(true)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Dados profissionais
  title             String?   // Cargo/Especialidade
  contractType      ContractType @default(PJ)
  remunerationType  RemunerationType @default(COMMISSION)
  commissionRate    Decimal?  @db.Decimal(5, 2) // Porcentagem
  fixedSalary       Decimal?  @db.Decimal(10, 2)
  businessHours     Json?     // Horário específico do profissional

  // Relacionamentos
  company       Company?  @relation(fields: [companyId], references: [id])
  companyId     String?

  // Relacionamentos de trabalho
  appointments      Appointment[] @relation("ProfessionalAppointments")
  transactions      Transaction[] @relation("ProfessionalTransactions")
  activities        Activity[]
  notifications     Notification[]
  assignedLeads     Lead[]

  // Índices para performance
  @@index([companyId])
  @@index([companyId, role])
  @@index([companyId, isActive])
  @@map("users")
}

enum UserRole {
  OWNER         // Dono do SaaS
  ADMIN         // Administrador da clínica
  RECEPTIONIST  // Recepcionista
  ESTHETICIAN   // Esteticista/Profissional
  PATIENT       // Paciente (acesso limitado)
}

enum ContractType {
  CLT
  PJ
  FREELANCER
}

enum RemunerationType {
  FIXED       // Apenas salário fixo
  COMMISSION  // Apenas comissão
  MIXED       // Fixo + Comissão
}

// ============================================
// MÓDULO: EMPRESAS (Multi-tenant)
// ============================================

model Company {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?
  address     String?
  city        String?   // Cidade da clínica
  state       String?   // Estado (sigla: SP, RJ, RS...)
  cnpj        String?
  presentation String?
  phones      String[] @default([])

  // Configuração de plano/assinatura
  plan                    Plan     @default(FREE)
  subscriptionStatus      SubscriptionStatus @default(TRIAL)
  subscriptionExpiresAt   DateTime?
  lastPlan                Plan?
  customPrice             Decimal? @db.Decimal(10, 2) // Preço negociado (ENTERPRISE)

  // Status de vendas (CRM do OWNER)
  salesStatus             SalesStatus @default(NEW)

  // Configurações de negócio
  businessHours           Json?    // BusinessHours object
  onlineBookingConfig     Json?    // OnlineBookingConfig object
  layoutConfig            Json?    // PublicLayoutConfig object
  paymentMethods          String[] @default([])

  // Público alvo
  targetFemale            Boolean  @default(true)
  targetMale              Boolean  @default(true)
  targetKids              Boolean  @default(false)

  // Redes sociais
  website                 String?
  facebook                String?
  instagram               String?

  // Controle
  onboardingCompleted     Boolean  @default(false)
  isActive                Boolean  @default(true)
  lastMarketingSentAt     DateTime?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relacionamentos
  users                User[]
  patients             Patient[]
  appointments         Appointment[]
  procedures           Procedure[]
  transactions         Transaction[]
  inventoryItems       InventoryItem[]
  photos               PhotoRecord[]
  unavailabilityRules  UnavailabilityRule[]
  notifications        AppNotification[]
  tickets              Ticket[]
  leads                Lead[]

  @@map("companies")
}

enum Plan {
  FREE        // Trial grátis
  BASIC       // Plano bloqueado (sem acesso) após trial expirar
  STARTER     // Primeiro plano pago
  PROFESSIONAL
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  OVERDUE
  CANCELED
}

enum SalesStatus {
  NEW           // Novo contato
  CONTACTED     // Em contato
  DEMO          // Demo agendada
  NEGOTIATION   // Em negociação
  WON           // Fechado (ganho)
  LOST          // Perdido
}

// ============================================
// MÓDULO: PACIENTES
// ============================================

model Patient {
  id              String   @id @default(cuid())
  name            String
  email           String
  phone           String
  birthDate       DateTime?
  cpf             String?
  status          PatientStatus @default(ACTIVE)

  // Anamnese e Consentimento
  anamnesisSummary        String?
  consentSignedAt         DateTime?
  consentSignatureUrl     String?   // Base64 ou URL
  consentMetadata         Json?     // SignatureMetadata
  anamnesisLinkSent       Boolean   @default(false)
  lastMarketingMessageSentAt DateTime?

  lastVisit       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacionamentos
  company         Company       @relation(fields: [companyId], references: [id])
  companyId       String
  appointments    Appointment[]
  photos          PhotoRecord[]
  transactions    Transaction[]

  // Índices para performance
  @@index([companyId])
  @@index([companyId, status])
  @@index([companyId, email])
  @@unique([email, companyId])
  @@map("patients")
}

enum PatientStatus {
  ACTIVE
  INACTIVE
  LEAD
}

// ============================================
// MÓDULO: PROCEDIMENTOS
// ============================================

model Procedure {
  id              String   @id @default(cuid())
  name            String
  description     String?
  imageUrl        String?
  price           Decimal  @db.Decimal(10, 2)
  cost            Decimal  @db.Decimal(10, 2) @default(0)
  durationMinutes Int      @default(60)
  isActive        Boolean  @default(true)

  // Marketing automático
  maintenanceRequired     Boolean @default(false)
  maintenanceIntervalDays Int?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacionamentos
  company         Company       @relation(fields: [companyId], references: [id])
  companyId       String
  supplies        ProcedureSupply[]
  appointments    Appointment[]

  // Índices para performance
  @@index([companyId])
  @@index([companyId, isActive])
  @@map("procedures")
}

model ProcedureSupply {
  id              String   @id @default(cuid())
  quantityUsed    Decimal  @db.Decimal(10, 2) // Quantidade consumida

  // Relacionamentos
  procedure       Procedure     @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  procedureId     String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  inventoryItemId String

  @@map("procedure_supplies")
}

// ============================================
// MÓDULO: AGENDAMENTOS
// ============================================

model Appointment {
  id              String   @id @default(cuid())
  date            DateTime
  durationMinutes Int
  price           Decimal  @db.Decimal(10, 2)
  status          AppointmentStatus @default(SCHEDULED)
  notes           String?
  paid            Boolean  @default(false)
  roomId          Int?
  stockDeducted   Boolean  @default(false)

  // Assinatura de procedimento
  signatureUrl    String?
  signatureMetadata Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacionamentos
  company         Company   @relation(fields: [companyId], references: [id])
  companyId       String
  patient         Patient   @relation(fields: [patientId], references: [id])
  patientId       String
  professional    User      @relation("ProfessionalAppointments", fields: [professionalId], references: [id])
  professionalId  String
  procedure       Procedure @relation(fields: [procedureId], references: [id])
  procedureId     String
  transactions    Transaction[]  // Múltiplas transações: INCOME (receita) + EXPENSE (custo insumos)

  // Índices para performance
  @@index([companyId])
  @@index([companyId, date])
  @@index([companyId, status])
  @@index([companyId, professionalId, date])
  @@index([patientId])
  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED         // Agendado
  CONFIRMED         // Confirmado
  COMPLETED         // Concluído
  CANCELED          // Cancelado
  PENDING_APPROVAL  // Aguardando aprovação (booking online)
}

// ============================================
// MÓDULO: FINANCEIRO - TRANSAÇÕES
// ============================================

model Transaction {
  id          String   @id @default(cuid())
  date        DateTime
  description String
  amount      Decimal  @db.Decimal(10, 2)
  type        TransactionType
  category    String
  status      TransactionStatus @default(PENDING)
  paymentMethod String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  company     Company     @relation(fields: [companyId], references: [id])
  companyId   String
  patient     Patient?    @relation(fields: [patientId], references: [id])
  patientId   String?
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  appointmentId String?   // Removido @unique para permitir múltiplas transações por agendamento (INCOME + EXPENSE)
  professional User?      @relation("ProfessionalTransactions", fields: [professionalId], references: [id])
  professionalId String?

  // Índices para performance
  @@index([companyId])
  @@index([companyId, date])
  @@index([companyId, type, status])
  @@index([companyId, type, status, date])
  @@map("transactions")
}

enum TransactionType {
  INCOME    // Receita
  EXPENSE   // Despesa
}

enum TransactionStatus {
  PAID      // Pago
  PENDING   // Pendente
  OVERDUE   // Vencido
  REFUNDED  // Estornado
}

// ============================================
// MÓDULO: ESTOQUE / INSUMOS
// ============================================

model InventoryItem {
  id              String   @id @default(cuid())
  name            String
  unit            String   // ml, un, cx, g
  currentStock    Decimal  @db.Decimal(10, 2)
  minStock        Decimal  @db.Decimal(10, 2) @default(5)
  costPerUnit     Decimal  @db.Decimal(10, 2)
  lastRestockDate DateTime?
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacionamentos
  company         Company   @relation(fields: [companyId], references: [id])
  companyId       String
  procedureSupplies ProcedureSupply[]
  stockMovements  StockMovement[]

  // Índices para performance
  @@index([companyId])
  @@index([companyId, isActive])
  @@map("inventory_items")
}

model StockMovement {
  id              String   @id @default(cuid())
  quantity        Decimal  @db.Decimal(10, 2)
  type            StockMovementType
  reason          String?
  createdAt       DateTime @default(now())

  // Relacionamentos
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  inventoryItemId String

  @@map("stock_movements")
}

enum StockMovementType {
  IN        // Entrada (reposição)
  OUT       // Saída (uso em procedimento)
  ADJUSTMENT // Ajuste manual
  LOSS      // Perda/Descarte
}

// ============================================
// MÓDULO: REGRAS DE INDISPONIBILIDADE
// ============================================

model UnavailabilityRule {
  id              String   @id @default(cuid())
  description     String?
  startTime       String   // HH:mm
  endTime         String   // HH:mm
  dates           String[] // Array de datas ISO
  professionalIds String[] // IDs dos profissionais afetados

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacionamentos
  company         Company  @relation(fields: [companyId], references: [id])
  companyId       String

  @@map("unavailability_rules")
}

// ============================================
// MÓDULO: LEADS (CRM)
// ============================================

model Lead {
  id          String     @id @default(cuid())
  name        String
  email       String?
  phone       String?
  source      String?    // instagram, google, indicação, etc
  status      LeadStatus @default(NEW)
  notes       String?
  lastContact DateTime?
  nextFollowUp DateTime?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relacionamentos
  company     Company    @relation(fields: [companyId], references: [id])
  companyId   String
  assignedTo  User?      @relation(fields: [assignedToId], references: [id])
  assignedToId String?

  @@map("leads")
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  WON
  LOST
}

// ============================================
// MÓDULO: FOTOS (EVOLUÇÃO)
// ============================================

model PhotoRecord {
  id          String   @id @default(cuid())
  date        DateTime
  url         String   // URL ou Base64
  type        PhotoType
  procedure   String
  groupId     String   // Para vincular antes/depois

  createdAt   DateTime @default(now())

  // Relacionamentos
  company     Company  @relation(fields: [companyId], references: [id])
  companyId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
  patientId   String

  @@map("photo_records")
}

enum PhotoType {
  BEFORE
  AFTER
}

// ============================================
// MÓDULO: ATIVIDADES E LOGS
// ============================================

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  title       String
  description String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime     @default(now())

  // Relacionamentos
  user        User         @relation(fields: [userId], references: [id])
  userId      String

  @@map("activities")
}

enum ActivityType {
  // Pacientes
  PATIENT_CREATED
  PATIENT_UPDATED
  CONSENT_SIGNED

  // Agendamentos
  APPOINTMENT_CREATED
  APPOINTMENT_CONFIRMED
  APPOINTMENT_COMPLETED
  APPOINTMENT_CANCELED

  // Financeiro
  PAYMENT_RECEIVED
  EXPENSE_CREATED

  // Estoque
  STOCK_ADJUSTED
  STOCK_LOW_ALERT

  // Leads
  LEAD_CREATED
  LEAD_STATUS_CHANGED
  LEAD_ASSIGNED

  // Sistema
  USER_LOGIN
  USER_LOGOUT
  SETTINGS_CHANGED
}

// ============================================
// MÓDULO: NOTIFICAÇÕES
// ============================================

model Notification {
  id          String   @id @default(cuid())
  title       String
  message     String
  type        NotificationType @default(INFO)
  isRead      Boolean  @default(false)
  link        String?
  createdAt   DateTime @default(now())

  // Relacionamentos
  user        User     @relation(fields: [userId], references: [id])
  userId      String

  @@map("notifications")
}

enum NotificationType {
  SUCCESS
  ERROR
  INFO
  WARNING
}

// Notificações da empresa (para todos os usuários)
model AppNotification {
  id          String   @id @default(cuid())
  message     String
  type        NotificationType @default(INFO)
  recipientId String?  // null = todos da empresa
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relacionamentos
  company     Company  @relation(fields: [companyId], references: [id])
  companyId   String

  @@map("app_notifications")
}

// ============================================
// MÓDULO: SUPORTE / TICKETS
// ============================================

model Ticket {
  id          String       @id @default(cuid())
  subject     String
  status      TicketStatus @default(OPEN)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relacionamentos
  company     Company         @relation(fields: [companyId], references: [id])
  companyId   String
  messages    TicketMessage[]

  @@map("tickets")
}

model TicketMessage {
  id          String   @id @default(cuid())
  content     String
  senderId    String
  senderName  String
  isAdmin     Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relacionamentos
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  ticketId    String

  @@map("ticket_messages")
}

enum TicketStatus {
  OPEN
  PENDING
  CLOSED
}

// ============================================
// MÓDULO: PLANOS SAAS
// ============================================

model SaasPlan {
  id               String   @id @default(cuid())
  name             String   @unique              // "FREE", "STARTER", "PROFESSIONAL", etc.
  displayName      String?                       // Nome amigável para UI
  price            Decimal  @db.Decimal(10, 2)
  maxProfessionals Int      @default(1)          // -1 = ilimitado
  maxPatients      Int      @default(50)         // -1 = ilimitado
  modules          String[] @default([])         // ["online_booking", "financial", ...]
  features         String[] @default([])         // Lista de features para marketing
  isActive         Boolean  @default(true)
  stripeProductId  String?
  stripePriceId    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("saas_plans")
}

// ============================================
// MÓDULO: ALERTAS DO SISTEMA
// ============================================

model SystemAlert {
  id          String          @id @default(cuid())
  title       String
  message     String
  type        NotificationType @default(INFO)
  target      String          // 'all' ou companyId específico
  status      AlertStatus     @default(ACTIVE)
  createdAt   DateTime        @default(now())

  @@map("system_alerts")
}

enum AlertStatus {
  ACTIVE
  INACTIVE
}

// ============================================
// MÓDULO: CONFIGURAÇÕES GLOBAIS DO SISTEMA
// ============================================

model SystemSettings {
  id                   String    @id @default("global")
  maintenanceMode      Boolean   @default(false)
  maintenanceMessage   String?   // Mensagem customizada opcional
  maintenanceStartedAt DateTime?
  maintenanceStartedBy String?   // userId do Owner que ativou
  updatedAt            DateTime  @updatedAt

  @@map("system_settings")
}

